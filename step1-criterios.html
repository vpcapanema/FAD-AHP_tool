<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Etapa 1: Sele√ß√£o de Crit√©rios - SIGMA AHP</title>

    <!-- SIGMA AHP specific styles -->
    <link rel="stylesheet" href="sigma-ahp.css">

    <!-- Font Awesome para √≠cones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <!-- Montserrat Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- PLI Navbar Header -->
    <header class="l-header">
        <nav class="pli-navbar">
            <div class="pli-navbar__container">
                <a href="sigma-ahp.html" class="pli-navbar__brand">
                    <i class="fas fa-calculator"></i> SIGMA - AHP Calculator
                </a>

                <ul class="pli-navbar__nav">
                    <li><a href="sigma-ahp.html" class="pli-navbar__link">In√≠cio</a></li>
                    <li><a href="#" class="pli-navbar__link pli-navbar__link--active">Calculadora</a></li>
                    <li><a href="#" class="pli-navbar__link">Ajuda</a></li>
                </ul>

                <div class="pli-navbar__utilities">
                    <button class="pli-navbar__notification">
                        <i class="fas fa-bell"></i>
                        <span class="pli-navbar__notification-badge">3</span>
                    </button>
                </div>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="l-main">
        <div class="l-container">
            <!-- Breadcrumb Navigation -->
            <nav class="breadcrumb">
                <a href="sigma-ahp.html"><i class="fas fa-home"></i> In√≠cio</a>
                <span class="breadcrumb-separator">/</span>
                <span class="breadcrumb-current">Etapa 1: Crit√©rios</span>
            </nav>

            <!-- Progress Bar -->
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-step active">
                        <div class="progress-circle">1</div>
                        <span>Crit√©rios</span>
                    </div>
                    <div class="progress-step">
                        <div class="progress-circle">2</div>
                        <span>Nomes</span>
                    </div>
                    <div class="progress-step">
                        <div class="progress-circle">3</div>
                        <span>M√©todo</span>
                    </div>
                    <div class="progress-step">
                        <div class="progress-circle">4</div>
                        <span>Compara√ß√£o</span>
                    </div>
                    <div class="progress-step">
                        <div class="progress-circle">5</div>
                        <span>Resultados</span>
                    </div>
                </div>
            </div>

            <!-- Info Card -->
            <section class="ahp-section info-card">
                <div class="info-card-header">
                    <i class="fas fa-info-circle"></i>
                    <h2>Sobre esta Etapa: Sele√ß√£o de Crit√©rios</h2>
                </div>
                <div class="info-card-content">
                    <p>Nesta primeira etapa, voc√™ definir√° a <strong>quantidade de crit√©rios</strong> que deseja comparar no processo de decis√£o multicrit√©rio.</p>
                    
                    <div class="info-highlights">
                        <div class="info-item">
                            <i class="fas fa-lightbulb"></i>
                            <div>
                                <strong>O que s√£o crit√©rios?</strong>
                                <p>Crit√©rios s√£o os fatores ou caracter√≠sticas que voc√™ deseja avaliar e comparar para tomar uma decis√£o. Por exemplo: custo, qualidade, tempo, risco, etc.</p>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-list-ol"></i>
                            <div>
                                <strong>Quantos crit√©rios escolher?</strong>
                                <p>Voc√™ pode selecionar de <strong>1 a 20 crit√©rios</strong>. Recomendamos entre 3 e 9 crit√©rios para uma an√°lise equilibrada e gerenci√°vel.</p>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-arrow-right"></i>
                            <div>
                                <strong>Pr√≥ximos passos</strong>
                                <p>Ap√≥s definir a quantidade, voc√™ nomear√° cada crit√©rio na pr√≥xima etapa e depois far√° as compara√ß√µes pareadas.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Main Content Section -->
            <section class="ahp-section">
                <h2 class="step-title">
                    <span class="step-number">1</span>
                    Escolha como deseja preencher a an√°lise AHP
                </h2>
                
                <!-- Dica sobre Upload -->
                <div class="recommendation-box">
                    <i class="fas fa-lightbulb"></i>
                    <div>
                        <strong>üí° Dica Importante:</strong>
                        <p>Se voc√™ possui <strong>mais de 20 crit√©rios</strong> ou j√° tem uma matriz calculada em outra ferramenta (Excel, Python, R), use a op√ß√£o <strong>"Upload de Matriz"</strong> para economizar tempo e evitar o preenchimento manual extenso.</p>
                    </div>
                </div>
                
                <!-- Op√ß√£o 1: M√©todo Manual -->
                <div class="method-choice-card">
                    <div class="method-choice-header">
                        <input type="radio" id="method-manual" name="input-method" value="manual" checked onchange="toggleInputMethod()">
                        <label for="method-manual">
                            <i class="fas fa-edit"></i> <strong>M√©todo Manual</strong>
                        </label>
                    </div>
                    <div id="manual-method-content" class="method-content">
                        <p>Preencha manualmente os crit√©rios e compara√ß√µes atrav√©s do processo guiado passo a passo.</p>
                        
                        <div class="c-form-group">
                            <label for="criteria-count" class="c-form-label">
                                <i class="fas fa-calculator"></i> N√∫mero de Crit√©rios
                            </label>
                            <select id="criteria-count" class="c-form-control" title="Selecione a quantidade de crit√©rios">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3" selected>3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10</option>
                                <option value="11">11</option>
                                <option value="12">12</option>
                                <option value="13">13</option>
                                <option value="14">14</option>
                                <option value="15">15</option>
                                <option value="16">16</option>
                                <option value="17">17</option>
                                <option value="18">18</option>
                                <option value="19">19</option>
                                <option value="20">20</option>
                            </select>
                            <small class="form-help">
                                <i class="fas fa-info-circle"></i> 
                                Recomendamos entre 3 e 9 crit√©rios para uma an√°lise equilibrada
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Op√ß√£o 2: Upload de Matriz -->
                <div class="method-choice-card">
                    <div class="method-choice-header">
                        <input type="radio" id="method-upload" name="input-method" value="upload" onchange="toggleInputMethod()">
                        <label for="method-upload">
                            <i class="fas fa-upload"></i> <strong>Upload de Matriz</strong>
                        </label>
                    </div>
                    <div id="upload-method-content" class="method-content method-content--hidden">
                        <p>Fa√ßa o upload de uma matriz de compara√ß√£o pareada previamente preenchida.</p>
                        
                        <div class="upload-steps">
                            <div class="upload-step">
                                <div class="step-number-badge">1</div>
                                <div class="step-content">
                                    <strong>Baixe o modelo</strong>
                                    <p>Escolha o formato de arquivo que preferir:</p>
                                    <div class="template-buttons">
                                        <button onclick="downloadMatrixTemplate('csv')" class="c-btn c-btn--outline">
                                            <i class="fas fa-file-csv"></i> Baixar Modelo CSV
                                        </button>
                                        <button onclick="downloadMatrixTemplate('json')" class="c-btn c-btn--outline">
                                            <i class="fas fa-file-code"></i> Baixar Modelo JSON
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="upload-step">
                                <div class="step-number-badge">2</div>
                                <div class="step-content">
                                    <strong>Preencha a matriz</strong>
                                    <p>Edite o arquivo baixado com suas compara√ß√µes pareadas usando a escala de Saaty (1-9).</p>
                                    <div class="info-box">
                                        <i class="fas fa-info-circle"></i>
                                        <div>
                                            <strong>Formato esperado:</strong>
                                            <ul class="info-list">
                                                <li>CSV: Matriz quadrada com nomes dos crit√©rios na primeira linha/coluna</li>
                                                <li>JSON: Objeto com arrays "criteria" e "matrix" (matriz quadrada)</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="upload-step">
                                <div class="step-number-badge">3</div>
                                <div class="step-content">
                                    <strong>Fa√ßa o upload</strong>
                                    <p>Selecione o arquivo preenchido para processar:</p>
                                    <div class="upload-area">
                                        <label for="matrix-file-input" class="visually-hidden">Selecionar arquivo de matriz AHP (CSV ou JSON)</label>
                                        <input type="file" id="matrix-file-input" accept=".csv,.json" onchange="handleFileSelect(event)" class="hidden-file-input" title="Selecionar arquivo de matriz AHP em formato CSV ou JSON">
                                        <button onclick="document.getElementById('matrix-file-input').click()" class="c-btn c-btn--secondary">
                                            <i class="fas fa-folder-open"></i> Selecionar Arquivo
                                        </button>
                                        <div id="file-info" class="file-info"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="c-form-actions">
                    <a href="sigma-ahp.html" class="c-btn c-btn--secondary">
                        <i class="fas fa-arrow-left c-btn__icon"></i>Voltar ao In√≠cio
                    </a>
                    <button id="continue-btn" onclick="processCriteriaCount()" class="c-btn c-btn--primary">
                        Continuar<i class="fas fa-arrow-right c-btn__icon c-btn__icon--right"></i>
                    </button>
                </div>
            </section>
        </div>
    </main>

    <!-- Footer -->
    <footer class="l-footer">
        <div class="l-footer__content">
            <p>&copy; 2025 SIGMA - Sistema Integrado de Gest√£o, Monitoramento e Apoio t√©cnico ao PLI/SP-2050. Todos os direitos reservados.</p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="js/script.js"></script>
    <script>
        // Vari√°vel global para armazenar dados do upload
        let uploadedMatrixData = null;

        // Alterna entre m√©todo manual e upload
        function toggleInputMethod() {
            const manualRadio = document.getElementById('method-manual');
            const uploadRadio = document.getElementById('method-upload');
            const manualContent = document.getElementById('manual-method-content');
            const uploadContent = document.getElementById('upload-method-content');
            const continueBtn = document.getElementById('continue-btn');

            if (manualRadio.checked) {
                manualContent.style.display = 'block';
                uploadContent.style.display = 'none';
                continueBtn.textContent = 'Continuar';
                continueBtn.innerHTML = 'Continuar<i class="fas fa-arrow-right c-btn__icon c-btn__icon--right"></i>';
                continueBtn.onclick = processCriteriaCount;
            } else if (uploadRadio.checked) {
                manualContent.style.display = 'none';
                uploadContent.style.display = 'block';
                continueBtn.textContent = 'Processar Matriz';
                continueBtn.innerHTML = '<i class="fas fa-check c-btn__icon"></i>Processar Matriz';
                continueBtn.onclick = processUploadedMatrix;
            }
        }

        // Baixa modelo de matriz em CSV ou JSON
        function downloadMatrixTemplate(format) {
            const sampleCriteria = ['Crit√©rio 1', 'Crit√©rio 2', 'Crit√©rio 3'];
            const sampleMatrix = [
                [1, 1, 1],
                [1, 1, 1],
                [1, 1, 1]
            ];

            if (format === 'csv') {
                let csvContent = ',' + sampleCriteria.join(',') + '\n';
                for (let i = 0; i < sampleCriteria.length; i++) {
                    let row = sampleCriteria[i];
                    for (let j = 0; j < sampleMatrix[i].length; j++) {
                        row += ',' + sampleMatrix[i][j];
                    }
                    csvContent += row + '\n';
                }
                csvContent += '\n# INSTRU√á√ïES:\n';
                csvContent += '# 1. Mantenha a primeira linha (nomes dos crit√©rios) e primeira coluna\n';
                csvContent += '# 2. Substitua os valores 1 pelas suas compara√ß√µes usando a escala de Saaty (1-9)\n';
                csvContent += '# 3. Diagonal principal deve sempre ser 1\n';
                csvContent += '# 4. Para cada par (i,j), se voc√™ preencher valor X, o par (j,i) ser√° automaticamente 1/X\n';
                csvContent += '# 5. Escala: 1=Igual, 3=Moderado, 5=Forte, 7=Muito forte, 9=Extremo (valores pares s√£o intermedi√°rios)\n';

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'modelo_matriz_ahp.csv';
                link.click();
                URL.revokeObjectURL(url);
                
                showNotification('Modelo CSV baixado com sucesso!', 'success');
            } else if (format === 'json') {
                const templateData = {
                    criteria: sampleCriteria,
                    matrix: sampleMatrix,
                    instructions: {
                        step1: 'Edite o array "criteria" com os nomes dos seus crit√©rios',
                        step2: 'Ajuste o tamanho da matriz "matrix" conforme o n√∫mero de crit√©rios',
                        step3: 'Preencha a matriz usando a escala de Saaty (1-9)',
                        scale: '1=Igual, 3=Moderado, 5=Forte, 7=Muito forte, 9=Extremo',
                        note: 'A diagonal principal deve sempre ser 1. Para cada par (i,j), o valor (j,i) ser√° automaticamente calculado como 1/valor(i,j)'
                    }
                };

                const jsonContent = JSON.stringify(templateData, null, 2);
                const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'modelo_matriz_ahp.json';
                link.click();
                URL.revokeObjectURL(url);
                
                showNotification('Modelo JSON baixado com sucesso!', 'success');
            }
        }

        // Manipula sele√ß√£o de arquivo
        function handleFileSelect(event) {
            const file = event.target.files[0];
            const fileInfo = document.getElementById('file-info');

            if (!file) {
                fileInfo.innerHTML = '';
                uploadedMatrixData = null;
                return;
            }

            const fileName = file.name;
            const fileSize = (file.size / 1024).toFixed(2) + ' KB';
            const fileExtension = fileName.split('.').pop().toLowerCase();

            fileInfo.innerHTML = `
                <div class="selected-file">
                    <i class="fas fa-file-alt"></i>
                    <div>
                        <strong>${fileName}</strong>
                        <small>${fileSize}</small>
                    </div>
                </div>
            `;

            // Ler o arquivo
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    
                    if (fileExtension === 'csv') {
                        uploadedMatrixData = parseCSVMatrix(content);
                    } else if (fileExtension === 'json') {
                        uploadedMatrixData = parseJSONMatrix(content);
                    } else {
                        throw new Error('Formato de arquivo n√£o suportado. Use CSV ou JSON.');
                    }

                    if (uploadedMatrixData) {
                        showNotification('Arquivo carregado com sucesso! Clique em "Processar Matriz" para continuar.', 'success');
                    }
                } catch (error) {
                    showNotification('Erro ao ler arquivo: ' + error.message, 'error');
                    uploadedMatrixData = null;
                }
            };

            reader.onerror = function() {
                showNotification('Erro ao ler o arquivo.', 'error');
                uploadedMatrixData = null;
            };

            reader.readAsText(file);
        }

        // Parse CSV matrix
        function parseCSVMatrix(content) {
            const lines = content.split('\n').filter(line => line.trim() && !line.trim().startsWith('#'));
            if (lines.length < 2) {
                throw new Error('Arquivo CSV inv√°lido: muito poucas linhas.');
            }

            const headerLine = lines[0].split(',').map(s => s.trim()).filter(s => s);
            const criteria = headerLine.slice(1); // Remove primeira coluna vazia
            const matrix = [];

            for (let i = 1; i < lines.length && i <= criteria.length; i++) {
                const parts = lines[i].split(',').map(s => s.trim());
                const row = [];
                for (let j = 1; j < parts.length && j <= criteria.length; j++) {
                    const value = parseFloat(parts[j]);
                    if (isNaN(value)) {
                        throw new Error(`Valor inv√°lido na linha ${i}, coluna ${j}: ${parts[j]}`);
                    }
                    row.push(value);
                }
                if (row.length === criteria.length) {
                    matrix.push(row);
                }
            }

            if (matrix.length !== criteria.length) {
                throw new Error(`Matriz n√£o √© quadrada. Crit√©rios: ${criteria.length}, Linhas: ${matrix.length}`);
            }

            // Validar matriz
            validateMatrix(criteria, matrix);

            return { criteria, matrix };
        }

        // Parse JSON matrix
        function parseJSONMatrix(content) {
            const data = JSON.parse(content);
            
            if (!data.criteria || !Array.isArray(data.criteria)) {
                throw new Error('JSON inv√°lido: propriedade "criteria" n√£o encontrada ou n√£o √© um array.');
            }
            
            if (!data.matrix || !Array.isArray(data.matrix)) {
                throw new Error('JSON inv√°lido: propriedade "matrix" n√£o encontrada ou n√£o √© um array.');
            }

            const criteria = data.criteria;
            const matrix = data.matrix;

            if (matrix.length !== criteria.length) {
                throw new Error(`Matriz n√£o √© quadrada. Crit√©rios: ${criteria.length}, Linhas: ${matrix.length}`);
            }

            for (let i = 0; i < matrix.length; i++) {
                if (!Array.isArray(matrix[i]) || matrix[i].length !== criteria.length) {
                    throw new Error(`Linha ${i+1} da matriz tem tamanho incorreto.`);
                }
            }

            // Validar matriz
            validateMatrix(criteria, matrix);

            return { criteria, matrix };
        }

        // Valida matriz de compara√ß√£o
        function validateMatrix(criteria, matrix) {
            const n = criteria.length;

            // Verificar diagonal principal
            for (let i = 0; i < n; i++) {
                if (matrix[i][i] !== 1) {
                    throw new Error(`Diagonal principal inv√°lida na posi√ß√£o [${i+1},${i+1}]. Deve ser 1, encontrado: ${matrix[i][i]}`);
                }
            }

            // Verificar reciprocidade (com toler√¢ncia)
            for (let i = 0; i < n; i++) {
                for (let j = i + 1; j < n; j++) {
                    const value = matrix[i][j];
                    const reciprocal = matrix[j][i];
                    const expectedReciprocal = 1 / value;
                    
                    if (Math.abs(reciprocal - expectedReciprocal) > 0.01) {
                        console.warn(`Aviso: Reciprocidade n√£o exata em [${i+1},${j+1}]. Valor: ${value}, Rec√≠proco esperado: ${expectedReciprocal}, Encontrado: ${reciprocal}`);
                    }
                }
            }

            return true;
        }

        // Processa matriz carregada e vai direto para resultados
        function processUploadedMatrix() {
            if (!uploadedMatrixData) {
                showNotification('Por favor, selecione um arquivo de matriz primeiro.', 'error');
                return;
            }

            try {
                // Salvar dados no localStorage
                const { criteria, matrix } = uploadedMatrixData;
                
                localStorage.setItem('ahp_criteriaCount', criteria.length);
                localStorage.setItem('ahp_criteria', JSON.stringify(criteria));
                localStorage.setItem('ahp_uploadedMatrix', JSON.stringify(matrix));
                localStorage.setItem('ahp_inputMethod', 'upload');

                showNotification('Processando matriz e calculando resultados...', 'info');

                // Redirecionar para step5 ap√≥s breve delay
                setTimeout(() => {
                    window.location.href = 'step5-resultados.html';
                }, 1000);

            } catch (error) {
                showNotification('Erro ao processar matriz: ' + error.message, 'error');
            }
        }

        // Processa contagem de crit√©rios (m√©todo manual)
        function processCriteriaCount() {
            const countSelect = document.getElementById("criteria-count");
            const criteriaCount = parseInt(countSelect.value);
            
            // Limpar dados de upload se existirem
            localStorage.removeItem('ahp_uploadedMatrix');
            localStorage.setItem('ahp_inputMethod', 'manual');
            
            // Salvar no localStorage
            localStorage.setItem('ahp_criteriaCount', criteriaCount);
            
            // Redirecionar para pr√≥xima p√°gina
            window.location.href = 'step2-nomes.html';
        }

        // Mostra notifica√ß√£o
        function showNotification(message, type) {
            const notificationDiv = document.createElement('div');
            notificationDiv.className = `notification notification-${type}`;
            notificationDiv.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notificationDiv);
            
            setTimeout(() => {
                notificationDiv.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => notificationDiv.remove(), 300);
            }, 4000);
        }

        // Restaurar valor salvo se existir
        document.addEventListener('DOMContentLoaded', function() {
            const savedCount = localStorage.getItem('ahp_criteriaCount');
            if (savedCount) {
                document.getElementById('criteria-count').value = savedCount;
            }

            const savedMethod = localStorage.getItem('ahp_inputMethod');
            if (savedMethod === 'upload') {
                document.getElementById('method-upload').checked = true;
                toggleInputMethod();
            }
        });
    </script>
</body>
</html>
